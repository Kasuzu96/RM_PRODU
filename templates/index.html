<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro RM Producciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* Estilos auxiliares */
        .hidden {
            display: none !important;
        }

        .logo-rm {
            max-width: 150px;
            margin-bottom: 20px;
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        #foto-preview {
            width: 100%;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <div class="container d-flex justify-content-center min-vh-100 align-items-center">
        <div class="card rm-card p-4 shadow-lg" style="width: 100%; max-width: 500px;">

            <div class="text-center">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="RM Producciones" class="logo-rm">
            </div>

            <div id="vista-camara" class="text-center">
                <h2 class="rm-title h4 mb-2">Captura tu momento</h2>

                <div class="mb-3 d-flex justify-content-center gap-2" id="mode-switch-container">
                    <button id="btn-mode-photo" class="btn btn-primary rounded-pill btn-sm px-4">ðŸ“¸ Foto</button>
                    <button id="btn-mode-video" class="btn btn-outline-primary rounded-pill btn-sm px-4">ðŸŽ¥
                        Video</button>
                </div>

                <div class="mb-3">
                    <select id="cameraSelect" class="form-select text-center" style="border-radius: 20px;">
                        <option value="" disabled selected>ðŸ”„ Cargando cÃ¡maras...</option>
                    </select>
                </div>

                <div class="video-container mb-4 position-relative">
                    <video id="video" autoplay playsinline></video>
                    <div id="timer-display" class="hidden position-absolute top-0 end-0 m-3 badge bg-danger fs-5">00:00
                    </div>
                </div>

                <button id="btn-capture" class="btn btn-primary btn-rm-primary w-100 py-2 rounded-pill"
                    onclick="tomarFoto()">
                    ðŸ“¸ Capturar FotografÃ­a
                </button>
            </div>

            <div id="vista-form" class="hidden">
                <h2 class="rm-title text-center h4 mb-3">Completa tus Datos</h2>

                <div class="photo-preview-container mb-4 text-center">
                    <img id="foto-preview" src="" alt="Tu foto" class="img-fluid shadow-sm">
                </div>

                <div class="mb-3">
                    <input type="text" class="form-control" id="nombre" placeholder="Nombre Completo" required>
                </div>
                <div class="mb-3">
                    <input type="tel" class="form-control" id="celular" placeholder="NÃºmero de Celular" required>
                </div>
                <div class="mb-4">
                    <input type="email" class="form-control" id="correo" placeholder="Correo ElectrÃ³nico" required>
                </div>

                <button class="btn btn-success w-100 mb-3 btn-send rounded-pill py-2" onclick="enviarDatos()">
                    ðŸš€ Enviar Foto
                </button>

                <button class="btn btn-outline-secondary w-100 rounded-pill py-2" onclick="reiniciar()">
                    ðŸ”„ Volver a tomar foto
                </button>
            </div>

            <div class="footer-text text-center mt-4 text-muted small">
                <p class="mb-1">Derechos reservados RM Producciones</p>
                <p class="mb-0">Desarrollado por <strong>Ludev</strong></p>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas'); // Lienzo invisible
        const fotoPreview = document.getElementById('foto-preview');
        const cameraSelect = document.getElementById('cameraSelect');
        let currentStream;
        let fotoDataURL = "";
        let mediaRecorder;
        let recordedChunks = [];
        let videoBlob = null;
        let recordingTime = 0;
        let recordingInterval;
        let isVideoMode = false;

        // URL del logo para la marca de agua (Flask la genera)
        const watermarkUrl = "{{ url_for('static', filename='img/logo.png') }}";

        // DOM Elements for UI
        const btnCapture = document.getElementById('btn-capture'); // We will rename the button ID in HTML
        const modeSwitchContainer = document.getElementById('mode-switch-container');
        const timerDisplay = document.getElementById('timer-display');

        // --- FUNCIONES DE CÃMARA ---
        async function startCamera(deviceId = null) {
            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    facingMode: deviceId ? undefined : "environment",
                    width: { ideal: 1280 }, height: { ideal: 720 }
                },
                audio: isVideoMode // Enable audio only for video mode
            };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                video.muted = true; // Mute preview to avoid feedback
                if (!deviceId) await listCameras();
            } catch (err) {
                console.error("Error cÃ¡mara:", err);
                if (!deviceId) { try { video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true, audio: isVideoMode }); } catch (e) { } }
            }
        }

        async function listCameras() {
            cameraSelect.innerHTML = "";
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            if (videoDevices.length === 0) { cameraSelect.innerHTML = "<option>No hay cÃ¡maras</option>"; return; }
            cameraSelect.add(new Option("Seleccionar CÃ¡mara â¬‡ï¸", "", true, true));
            videoDevices.forEach((device, i) => {
                let label = device.label || `CÃ¡mara ${i + 1}`;
                if (label.toLowerCase().includes('back') || label.toLowerCase().includes('trasera')) label = "ðŸ“¸ CÃ¡mara Trasera";
                else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('frontal')) label = "ðŸ¤³ CÃ¡mara Selfie";
                cameraSelect.add(new Option(label, device.deviceId));
            });
            cameraSelect.onchange = () => startCamera(cameraSelect.value);
        }

        // --- MODO TOGGLE ---
        function setMode(mode) {
            isVideoMode = mode === 'video';

            // Update UI Buttons
            document.getElementById('btn-mode-photo').classList.toggle('btn-primary', !isVideoMode);
            document.getElementById('btn-mode-photo').classList.toggle('btn-outline-primary', isVideoMode);
            document.getElementById('btn-mode-video').classList.toggle('btn-primary', isVideoMode);
            document.getElementById('btn-mode-video').classList.toggle('btn-outline-primary', !isVideoMode);

            // Update Capture Button
            const btn = document.getElementById('btn-capture');
            if (isVideoMode) {
                btn.innerHTML = "ðŸ”´ Grabar Video";
                btn.classList.remove('btn-rm-primary'); // Remove default orange/blue if any
                btn.classList.add('btn-danger'); // Red for recording
                btn.onclick = toggleRecording;
                timerDisplay.classList.remove('hidden');
            } else {
                btn.innerHTML = "ðŸ“¸ Capturar FotografÃ­a";
                btn.classList.add('btn-rm-primary');
                btn.classList.remove('btn-danger');
                btn.onclick = tomarFoto;
                timerDisplay.classList.add('hidden');
            }

            // Restart camera to pick up audio permissions if needed
            if (cameraSelect.value) startCamera(cameraSelect.value); else startCamera();
        }

        // --- VIDEO RECORDING ---
        function toggleRecording() {
            const btn = document.getElementById('btn-capture');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            const options = { mimeType: 'video/webm; codecs=vp9' };

            try {
                mediaRecorder = new MediaRecorder(currentStream, options);
            } catch (e) {
                console.warn("VP9 not supported, trying default.");
                mediaRecorder = new MediaRecorder(currentStream);
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                const videoUrl = URL.createObjectURL(videoBlob);

                // Show preview
                fotoPreview.src = ""; // Clear img source
                fotoPreview.classList.add('hidden'); // Hide img

                // Configure preview video element
                let previewVideo = document.getElementById('video-preview-playback');
                if (!previewVideo) {
                    previewVideo = document.createElement('video');
                    previewVideo.id = 'video-preview-playback';
                    previewVideo.controls = true;
                    previewVideo.classList.add('img-fluid', 'shadow-sm', 'rounded');
                    document.querySelector('.photo-preview-container').appendChild(previewVideo);
                }
                previewVideo.src = videoUrl;
                previewVideo.classList.remove('hidden');

                // Display form
                document.getElementById('vista-camara').classList.add('hidden');
                document.getElementById('vista-form').classList.remove('hidden');
            };

            mediaRecorder.start();
            document.getElementById('btn-capture').innerHTML = "â¹ Detener (00:00)";

            // Timer
            recordingTime = 0;
            timerDisplay.innerText = "00:00";
            recordingInterval = setInterval(() => {
                recordingTime++;
                const mins = Math.floor(recordingTime / 60).toString().padStart(2, '0');
                const secs = (recordingTime % 60).toString().padStart(2, '0');
                document.getElementById('btn-capture').innerHTML = `â¹ Detener (${mins}:${secs})`;
                timerDisplay.innerText = `${mins}:${secs}`;

                if (recordingTime >= 120) { // 2 minutes limit
                    stopRecording();
                }
            }, 1000);
        }

        function stopRecording() {
            mediaRecorder.stop();
            clearInterval(recordingInterval);
            document.getElementById('btn-capture').innerHTML = "ðŸ”´ Grabar Video";
        }

        // --- FOTO (Legacy + Watermark) ---
        function tomarFoto() {
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            const watermarkImg = new Image();
            watermarkImg.src = watermarkUrl;
            watermarkImg.crossOrigin = "Anonymous";

            watermarkImg.onload = () => {
                const logoWidth = canvas.width * 0.25;
                const scaleFactor = logoWidth / watermarkImg.width;
                const logoHeight = watermarkImg.height * scaleFactor;
                const padding = 30;
                const xPosition = padding;
                const yPosition = canvas.height - logoHeight - padding;

                ctx.drawImage(watermarkImg, xPosition, yPosition, logoWidth, logoHeight);
                processFoto();
            };

            watermarkImg.onerror = () => {
                console.error("Error cargando watermark");
                processFoto();
            }

            function processFoto() {
                fotoDataURL = canvas.toDataURL('image/png');
                fotoPreview.src = fotoDataURL;
                fotoPreview.classList.remove('hidden');

                const vPrev = document.getElementById('video-preview-playback');
                if (vPrev) vPrev.classList.add('hidden');

                document.getElementById('vista-camara').classList.add('hidden');
                document.getElementById('vista-form').classList.remove('hidden');
            }
        }

        // --- UTILS ---
        function reiniciar() {
            document.getElementById('vista-form').classList.add('hidden');
            document.getElementById('vista-camara').classList.remove('hidden');

            // Reset state
            videoBlob = null;
            fotoDataURL = "";
            const vPrev = document.getElementById('video-preview-playback');
            if (vPrev) { vPrev.pause(); vPrev.src = ""; }

            if (cameraSelect.value) startCamera(cameraSelect.value); else startCamera();
        }

        async function enviarDatos() {
            const nombre = document.getElementById('nombre').value;
            const celular = document.getElementById('celular').value;
            const correo = document.getElementById('correo').value;

            if (!nombre || !celular || !correo) return alert("Completa todos los campos.");

            const btn = document.querySelector('.btn-send');
            const textoOriginal = btn.innerText;
            btn.innerText = "Enviando..."; btn.disabled = true;

            try {
                // Use FormData for Multipart upload
                const formData = new FormData();
                formData.append('nombre', nombre);
                formData.append('celular', celular);
                formData.append('correo', correo);

                if (isVideoMode && videoBlob) {
                    formData.append('video', videoBlob, 'video_recuerdo.webm');
                } else if (fotoDataURL) {
                    formData.append('foto_base64', fotoDataURL);
                    // Also sending as file blob if backend prefers standard
                    // const fetchResponse = await fetch(fotoDataURL);
                    // const blob = await fetchResponse.blob();
                    // formData.append('foto', blob, 'foto_recuerdo.png');
                }

                const respuesta = await fetch('/guardar', {
                    method: 'POST',
                    body: formData // No Content-Type header needed, browser sets it
                });

                const resultado = await respuesta.json();
                if (resultado.status === 'ok') {
                    alert("Â¡Enviado! ðŸš€ Revisa Promociones/Spam."); location.reload();
                } else throw new Error(resultado.mensaje);
            } catch (error) {
                alert("Error: " + error.message);
                btn.innerText = textoOriginal; btn.disabled = false;
            }
        }

        window.addEventListener('load', () => {
            startCamera();
            // Bind initial buttons
            document.getElementById('btn-mode-photo').onclick = () => setMode('photo');
            document.getElementById('btn-mode-video').onclick = () => setMode('video');
        });
    </script>
</body>

</html>