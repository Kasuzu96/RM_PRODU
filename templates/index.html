<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro RM Producciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* Estilos auxiliares */
        .hidden { display: none !important; }
        .logo-rm { max-width: 150px; margin-bottom: 20px; }
        video { width: 100%; border-radius: 10px; }
        #foto-preview { width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="container d-flex justify-content-center min-vh-100 align-items-center">
        <div class="card rm-card p-4 shadow-lg" style="width: 100%; max-width: 500px;">
            
            <div class="text-center">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="RM Producciones" class="logo-rm">
            </div>

            <div id="vista-camara" class="text-center">
                <h2 class="rm-title h4 mb-2">Captura tu momento</h2>
                
                <div class="mb-3">
                    <select id="cameraSelect" class="form-select text-center" style="border-radius: 20px;">
                        <option value="" disabled selected>游댃 Cargando c치maras...</option>
                    </select>
                </div>
                
                <div class="video-container mb-4 position-relative">
                    <video id="video" autoplay playsinline></video>
                </div>
                
                <button class="btn btn-primary btn-rm-primary w-100 py-2 rounded-pill" onclick="tomarFoto()">
                    游닞 Capturar Fotograf칤a
                </button>
            </div>

            <div id="vista-form" class="hidden">
                <h2 class="rm-title text-center h4 mb-3">Completa tus Datos</h2>
                
                <div class="photo-preview-container mb-4 text-center">
                    <img id="foto-preview" src="" alt="Tu foto" class="img-fluid shadow-sm">
                </div>

                <div class="mb-3">
                    <input type="text" class="form-control" id="nombre" placeholder="Nombre Completo" required>
                </div>
                <div class="mb-3">
                    <input type="tel" class="form-control" id="celular" placeholder="N칰mero de Celular" required>
                </div>
                <div class="mb-4">
                    <input type="email" class="form-control" id="correo" placeholder="Correo Electr칩nico" required>
                </div>

                <button class="btn btn-success w-100 mb-3 btn-send rounded-pill py-2" onclick="enviarDatos()">
                    游 Enviar Foto
                </button>
                
                <button class="btn btn-outline-secondary w-100 rounded-pill py-2" onclick="reiniciar()">
                    游댃 Volver a tomar foto
                </button>
            </div>

            <div class="footer-text text-center mt-4 text-muted small">
                <p class="mb-1">Derechos reservados RM Producciones</p>
                <p class="mb-0">Desarrollado por <strong>Ludev</strong></p>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas'); // Lienzo invisible
        const fotoPreview = document.getElementById('foto-preview');
        const cameraSelect = document.getElementById('cameraSelect');
        let currentStream;
        let fotoDataURL = "";

        // URL del logo para la marca de agua (Flask la genera)
        const watermarkUrl = "{{ url_for('static', filename='img/logo.png') }}";

        // --- FUNCIONES DE C츼MARA (Sin cambios) ---
        async function startCamera(deviceId = null) {
            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    facingMode: deviceId ? undefined : "environment",
                    width: { ideal: 1280 }, height: { ideal: 720 }
                }
            };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                if (!deviceId) await listCameras();
            } catch (err) {
                console.error("Error c치mara:", err);
                if (!deviceId) { try { video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true }); } catch(e){} }
            }
        }

        async function listCameras() {
            cameraSelect.innerHTML = "";
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            if (videoDevices.length === 0) { cameraSelect.innerHTML = "<option>No hay c치maras</option>"; return; }
            cameraSelect.add(new Option("Seleccionar C치mara 拘勇", "", true, true));
            videoDevices.forEach((device, i) => {
                let label = device.label || `C치mara ${i + 1}`;
                if (label.toLowerCase().includes('back') || label.toLowerCase().includes('trasera')) label = "游닞 C치mara Trasera";
                else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('frontal')) label = "游뱝 C치mara Selfie";
                cameraSelect.add(new Option(label, device.deviceId));
            });
            cameraSelect.onchange = () => startCamera(cameraSelect.value);
        }

        // --- NUEVA FUNCI칍N TOMAR FOTO (CON MARCA DE AGUA) ---
        function tomarFoto() {
            const ctx = canvas.getContext('2d');
            
            // 1. Configurar dimensiones del lienzo igual al video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // 2. Dibujar la foto del video primero
            ctx.drawImage(video, 0, 0);

            // 3. Cargar la imagen del logo para la marca de agua
            const watermarkImg = new Image();
            watermarkImg.src = watermarkUrl;
            // Importante: Permitir carga de imagen local para que no de error de seguridad
            watermarkImg.crossOrigin = "Anonymous"; 

            // 4. Esperar a que el logo cargue antes de dibujarlo
            watermarkImg.onload = () => {
                // --- Configuraci칩n del Logo ---
                // Hacemos que el logo ocupe el 25% del ancho de la foto
                const logoWidth = canvas.width * 0.25; 
                // Calculamos el alto proporcional para que no se deforme
                const scaleFactor = logoWidth / watermarkImg.width;
                const logoHeight = watermarkImg.height * scaleFactor;

                // Margen desde la esquina (puedes ajustar este n칰mero)
                const padding = 30; 

                // Posici칩n X (izquierda)
                const xPosition = padding;
                // Posici칩n Y (abajo - altura del logo - margen)
                const yPosition = canvas.height - logoHeight - padding;

                // Opcional: Hacerlo un poco transparente (descomenta si quieres)
                // ctx.globalAlpha = 0.8; 

                // Dibujar el logo sobre la foto
                ctx.drawImage(watermarkImg, xPosition, yPosition, logoWidth, logoHeight);

                // ctx.globalAlpha = 1.0; // Resetear transparencia

                // --- Finalizar proceso ---
                // Convertir el lienzo combinado a imagen Base64
                fotoDataURL = canvas.toDataURL('image/png');
                // Mostrar en la previsualizaci칩n
                fotoPreview.src = fotoDataURL;
                
                // Cambiar vista
                document.getElementById('vista-camara').classList.add('hidden');
                document.getElementById('vista-form').classList.remove('hidden');
            };

            // Si el logo falla al cargar, tomar la foto sin 칠l
            watermarkImg.onerror = (err) => {
                console.error("Error cargando watermark, enviando sin logo.", err);
                fotoDataURL = canvas.toDataURL('image/png');
                fotoPreview.src = fotoDataURL;
                document.getElementById('vista-camara').classList.add('hidden');
                document.getElementById('vista-form').classList.remove('hidden');
            }
        }

        // --- FUNCIONES AUXILIARES (Sin cambios) ---
        function reiniciar() {
            document.getElementById('vista-form').classList.add('hidden');
            document.getElementById('vista-camara').classList.remove('hidden');
            if (cameraSelect.value) startCamera(cameraSelect.value); else startCamera();
        }

        async function enviarDatos() {
            const nombre = document.getElementById('nombre').value;
            const celular = document.getElementById('celular').value;
            const correo = document.getElementById('correo').value;
            if (!nombre || !celular || !correo) return alert("Completa todos los campos.");
            
            const btn = document.querySelector('.btn-send');
            const textoOriginal = btn.innerText;
            btn.innerText = "Enviando..."; btn.disabled = true;

            try {
                const respuesta = await fetch('/guardar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, celular, correo, foto: fotoDataURL })
                });
                const resultado = await respuesta.json();
                if (resultado.status === 'ok') {
                    alert("춰Enviado! 游 Revisa Promociones/Spam."); location.reload();
                } else throw new Error(resultado.mensaje);
            } catch (error) {
                alert("Error: " + error.message);
                btn.innerText = textoOriginal; btn.disabled = false;
            }
        }
        window.addEventListener('load', () => startCamera());
    </script>
</body>
</html>