<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro RM Producciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* Estilos auxiliares por si falta algo en style.css */
        .hidden { display: none !important; }
        .logo-rm { max-width: 150px; margin-bottom: 20px; }
        video { width: 100%; border-radius: 10px; }
        #foto-preview { width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="container d-flex justify-content-center min-vh-100 align-items-center">
        <div class="card rm-card p-4 shadow-lg" style="width: 100%; max-width: 500px;">
            
            <div class="text-center">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="RM Producciones" class="logo-rm">
            </div>

            <div id="vista-camara" class="text-center">
                <h2 class="rm-title h4 mb-2">Captura tu momento</h2>
                
                <div class="mb-3">
                    <select id="cameraSelect" class="form-select text-center" style="border-radius: 20px;">
                        <option value="" disabled selected>游댃 Cargando c치maras...</option>
                    </select>
                </div>
                
                <div class="video-container mb-4 position-relative">
                    <video id="video" autoplay playsinline></video>
                </div>
                
                <button class="btn btn-primary btn-rm-primary w-100 py-2 rounded-pill" onclick="tomarFoto()">
                    游닞 Capturar Fotograf칤a
                </button>
            </div>

            <div id="vista-form" class="hidden">
                <h2 class="rm-title text-center h4 mb-3">Completa tus Datos</h2>
                
                <div class="photo-preview-container mb-4 text-center">
                    <img id="foto-preview" src="" alt="Tu foto" class="img-fluid shadow-sm">
                </div>

                <div class="mb-3">
                    <input type="text" class="form-control" id="nombre" placeholder="Nombre Completo" required>
                </div>
                <div class="mb-3">
                    <input type="tel" class="form-control" id="celular" placeholder="N칰mero de Celular" required>
                </div>
                <div class="mb-4">
                    <input type="email" class="form-control" id="correo" placeholder="Correo Electr칩nico" required>
                </div>

                <button class="btn btn-success w-100 mb-3 btn-send rounded-pill py-2" onclick="enviarDatos()">
                    游 Enviar Foto
                </button>
                
                <button class="btn btn-outline-secondary w-100 rounded-pill py-2" onclick="reiniciar()">
                    游댃 Volver a tomar foto
                </button>
            </div>

            <div class="footer-text text-center mt-4 text-muted small">
                <p class="mb-1">Derechos reservados RM Producciones</p>
                <p class="mb-0">Desarrollado por <strong>Ludev</strong></p>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- JAVASCRIPT CON L칍GICA DE SELECCI칍N DE C츼MARA ---
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        const fotoPreview = document.getElementById('foto-preview');
        const cameraSelect = document.getElementById('cameraSelect');
        let currentStream;
        let fotoDataURL = "";

        // 1. FUNCI칍N PARA INICIAR C츼MARA (CON ID ESPEC칈FICO)
        async function startCamera(deviceId = null) {
            // Detener stream anterior si existe para liberar recursos
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    // Si no hay ID, intenta la trasera (environment), si no, la frontal
                    facingMode: deviceId ? undefined : "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                video.srcObject = stream;
                
                // Si es la primera vez (no hay deviceId), listamos las c치maras
                if (!deviceId) {
                    await listCameras();
                }
            } catch (err) {
                console.error("Error accediendo a la c치mara:", err);
                // Fallback: intentar cualquier c치mara si la configuraci칩n falla
                if (!deviceId) {
                    try {
                        const simpleStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        currentStream = simpleStream;
                        video.srcObject = simpleStream;
                    } catch (e) {
                        alert("No se pudo acceder a la c치mara. Revisa permisos.");
                    }
                }
            }
        }

        // 2. FUNCI칍N PARA LLENAR EL SELECTOR
        async function listCameras() {
            cameraSelect.innerHTML = ""; // Limpiar
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            if (videoDevices.length === 0) {
                const option = document.createElement('option');
                option.text = "No se encontraron c치maras";
                cameraSelect.add(option);
                return;
            }

            // Opci칩n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.text = "Seleccionar C치mara 拘勇";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            cameraSelect.add(defaultOption);

            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                
                // Nombres amigables
                let label = device.label || `C치mara ${index + 1}`;
                if (label.toLowerCase().includes('back') || label.toLowerCase().includes('trasera')) {
                    label = "游닞 C치mara Trasera";
                } else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('frontal')) {
                    label = "游뱝 C치mara Selfie";
                }

                option.text = label;
                cameraSelect.add(option);
            });

            // Evento al cambiar opci칩n
            cameraSelect.onchange = () => {
                startCamera(cameraSelect.value);
            };
        }

        // 3. CAPTURAR FOTO
        function tomarFoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            fotoDataURL = canvas.toDataURL('image/png');
            fotoPreview.src = fotoDataURL;
            
            // Cambio de vistas usando clases Bootstrap/CSS
            document.getElementById('vista-camara').classList.add('hidden');
            document.getElementById('vista-form').classList.remove('hidden');
        }

        // 4. REINICIAR
        function reiniciar() {
            document.getElementById('vista-form').classList.add('hidden');
            document.getElementById('vista-camara').classList.remove('hidden');
            // Reactivar c치mara por si acaso se paus칩
            if (cameraSelect.value) {
                startCamera(cameraSelect.value);
            } else {
                startCamera();
            }
        }

        // 5. ENVIAR DATOS (TU L칍GICA ORIGINAL)
        async function enviarDatos() {
            const nombre = document.getElementById('nombre').value;
            const celular = document.getElementById('celular').value;
            const correo = document.getElementById('correo').value;

            if (!nombre || !celular || !correo) {
                alert("Por favor, completa todos los campos.");
                return;
            }

            const btn = document.querySelector('.btn-send');
            const textoOriginal = btn.innerText;
            btn.innerText = "Enviando...";
            btn.disabled = true;

            try {
                const respuesta = await fetch('/guardar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, celular, correo, foto: fotoDataURL })
                });
                const resultado = await respuesta.json();

                if (resultado.status === 'ok') {
                    alert("춰Enviado! 游 Revisa la carpeta de Promociones/Spam.");
                    location.reload();
                } else {
                    throw new Error(resultado.mensaje);
                }
            } catch (error) {
                alert("Error: " + error.message);
                btn.innerText = textoOriginal;
                btn.disabled = false;
            }
        }

        // Iniciar al cargar
        window.addEventListener('load', () => startCamera());
    </script>
</body>
</html>